---
/**
 * AdminLayout.astro
 * Layout para el panel de administración
 * Protección se maneja en el cliente
 */

interface Props {
  title?: string;
}

const { title = 'Panel Administrativo' } = Astro.props;
---

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{title} - JGMarket Admin</title>
  <style>
    :root {
      --jd-black: #000000;
      --jd-red: #E2001A;
      --jd-turquoise: #1FC0A0;
      --jd-gray: #F6F6F6;
      --jd-darkGray: #333333;
    }
  </style>
</head>
<body class="bg-jd-gray text-jd-black">
  <!-- Loading screen -->
  <div id="loading-screen" class="flex items-center justify-center min-h-screen bg-jd-gray">
    <div class="text-center">
      <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-jd-red mb-4"></div>
      <p class="text-gray-600 font-semibold">Verificando acceso...</p>
    </div>
  </div>

  <!-- Admin Content -->
  <div id="admin-content" class="hidden">
    <!-- Navbar -->
    <nav class="bg-white border-b-2 border-jd-gray sticky top-0 z-50 shadow-sm">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
          <a href="/admin" class="flex items-center gap-3 group">
            <div class="w-10 h-10 bg-jd-red rounded-lg flex items-center justify-center">
              <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
              </svg>
            </div>
            <span class="font-black text-lg text-jd-black group-hover:text-jd-red transition">JGMarket Admin</span>
          </a>
          <div class="flex items-center gap-4">
            <a href="/" class="text-sm font-bold text-gray-600 hover:text-jd-black transition">Ir a la tienda</a>
          </div>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-12">
      <slot />
    </main>
  </div>

  <script>
    // Función para mostrar modal de confirmación
    window.showLogoutConfirmModal = function() {
      return new Promise((resolve) => {
        // Crear overlay
        const overlay = document.createElement('div');
        overlay.className = 'fixed inset-0 bg-black/50 z-50 flex items-center justify-center';
        
        // Crear modal
        const modal = document.createElement('div');
        modal.className = 'bg-white rounded-lg shadow-2xl max-w-sm mx-4 p-8';
        modal.innerHTML = `
          <h2 class="text-2xl font-bold text-gray-900 mb-3">Cerrar Sesión</h2>
          <p class="text-gray-600 mb-8">¿Estás seguro de que deseas cerrar sesión?</p>
          <div class="flex gap-3 justify-end">
            <button id="modal-cancel" class="px-6 py-2 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition">
              Cancelar
            </button>
            <button id="modal-confirm" class="px-6 py-2 bg-jd-red text-white font-semibold rounded-lg hover:bg-red-700 transition">
              Cerrar Sesión
            </button>
          </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // Handlers de botones
        const cancelBtn = modal.querySelector('#modal-cancel');
        const confirmBtn = modal.querySelector('#modal-confirm');
        
        const closeModal = () => {
          overlay.remove();
        };
        
        cancelBtn?.addEventListener('click', () => {
          closeModal();
          resolve(false);
        });
        
        confirmBtn?.addEventListener('click', () => {
          closeModal();
          resolve(true);
        });
        
        // Cerrar con ESC
        const handleKeydown = (e) => {
          if (e.key === 'Escape') {
            closeModal();
            resolve(false);
            document.removeEventListener('keydown', handleKeydown);
          }
        };
        
        document.addEventListener('keydown', handleKeydown);
      });
    };

    // Función para cerrar sesión
    window.logout = async function() {
      // Mostrar modal de confirmación
      const confirmed = await window.showLogoutConfirmModal();
      if (!confirmed) {
        return;
      }

      try {
        const response = await fetch('/api/auth/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          // Limpiar localStorage
          localStorage.removeItem('isGuest');
          localStorage.removeItem('guestLoginTime');
          localStorage.removeItem('isAuthenticated');
          localStorage.removeItem('userEmail');
          // Redirigir a login
          window.location.href = '/login';
        } else {
          alert('Error al cerrar sesión');
        }
      } catch (error) {
        console.error('Error logging out:', error);
        alert('Error al cerrar sesión');
      }
    };

    (async () => {
      try {
        // Importar supabaseClient dinámicamente
        const { supabaseClient } = await import('../lib/supabase');
        
        // Verificar sesión directamente en el cliente
        const { data: { session } } = await supabaseClient.auth.getSession();
        
        if (!session) {
          // No hay sesión, redirigir a login
          window.location.href = '/login';
          return;
        }

        // Verificar si es admin
        const isAdmin = session.user.email?.toLowerCase() === 'jaimechipiona2006@gmail.com';
        
        if (!isAdmin) {
          // No es admin, redirigir a productos
          window.location.href = '/productos';
          return;
        }

        // Si llegamos aquí, el usuario es admin válido
        const loadingScreen = document.getElementById('loading-screen');
        const adminContent = document.getElementById('admin-content');
        if (loadingScreen) loadingScreen.style.display = 'none';
        if (adminContent) adminContent.classList.remove('hidden');
      } catch (error) {
        console.error('Error checking auth:', error);
        window.location.href = '/login';
      }
    })();
  </script>
</body>
</html>
