---
/**
 * src/pages/success.astro
 * P√°gina de confirmaci√≥n de pago exitoso
 */

import PublicLayout from "../layouts/PublicLayout.astro";

const sessionId = Astro.url.searchParams.get('session_id');
---

<PublicLayout title="Pago Completado - JGMarket">
    <div class="bg-jd-gray min-h-screen">
        <div class="max-w-2xl mx-auto px-4 py-12">
            <!-- Success Header -->
            <div class="bg-white rounded-lg p-8 text-center mb-8">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-black text-jd-black mb-2">¬°Pago Completado!</h1>
                <p class="text-gray-600 mb-4">Tu pedido ha sido confirmado exitosamente</p>
                {sessionId && (
                    <p class="text-sm text-gray-500 font-mono bg-gray-100 p-2 rounded">
                        Session: {sessionId.substring(0, 20)}...
                    </p>
                )}
            </div>

            <!-- Order Details -->
            <div class="bg-white rounded-lg p-8 mb-8">
                <h2 class="text-xl font-bold text-jd-black mb-6 uppercase">Detalles del Pedido</h2>
                
                <div id="order-details" class="space-y-4 mb-6">
                    <div class="flex justify-between py-2 border-b border-gray-200">
                        <span class="text-gray-600">Subtotal</span>
                        <span id="detail-subtotal" class="font-bold">‚Ç¨0.00</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-200">
                        <span class="text-gray-600">Env√≠o</span>
                        <span id="detail-shipping" class="font-bold text-jd-turquoise">GRATIS</span>
                    </div>
                    <div class="flex justify-between py-3 text-lg font-bold">
                        <span>Total</span>
                        <span id="detail-total" class="text-jd-red">‚Ç¨0.00</span>
                    </div>
                </div>

                <div id="items-container" class="border-t border-gray-200 pt-6 space-y-4">
                    <!-- Items will be rendered here -->
                </div>
            </div>

            <!-- Actions -->
            <div class="space-y-4">
                <button 
                    id="download-invoice-btn"
                    class="w-full bg-jd-turquoise text-white font-bold py-3 rounded uppercase hover:bg-opacity-90 transition"
                >
                    üìÑ Descargar Factura (PDF)
                </button>
                
                <a 
                    href="/account#orders"
                    class="block text-center bg-jd-black text-white font-bold py-3 rounded uppercase hover:bg-opacity-90 transition"
                >
                    Ver Mis Pedidos
                </a>

                <a 
                    href="/productos"
                    class="block text-center bg-white text-jd-black font-bold py-3 rounded uppercase border-2 border-jd-black hover:bg-gray-100 transition"
                >
                    Continuar Comprando
                </a>
            </div>

            <!-- Info Message -->
            <div class="mt-8 bg-blue-50 border border-blue-200 rounded p-4 text-sm text-gray-700">
                <p class="font-bold text-blue-900 mb-2">‚ÑπÔ∏è Informaci√≥n Importante</p>
                <ul class="list-disc list-inside space-y-1">
                    <li>Tu carrito ha sido vaciado autom√°ticamente</li>
                    <li>Recibir√°s un email de confirmaci√≥n en breve</li>
                    <li>Tu pedido est√° disponible en la secci√≥n "Mis Pedidos"</li>
                    <li>Tiempo de entrega: 3-5 d√≠as laborales</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Datos del carrito antes de pagar
        const CART_KEY = 'fashionmarket_cart';
        const SESSION_ID = new URLSearchParams(window.location.search).get('session_id');

        function getCart() {
            const stored = localStorage.getItem(CART_KEY);
            if (!stored) return [];
            
            try {
                const parsed = JSON.parse(stored);
                if (parsed.items && Array.isArray(parsed.items)) {
                    return parsed.items;
                }
                return Array.isArray(parsed) ? parsed : [];
            } catch {
                return [];
            }
        }

        function clearCart() {
            localStorage.removeItem(CART_KEY);
            console.log('Carrito vaciado');
        }

        function renderOrderDetails() {
            const cart = getCart();
            const container = document.getElementById('items-container');
            
            if (!container || cart.length === 0) return;

            let subtotal = 0;
            
            const itemsHtml = cart.map((item: any) => {
                const itemTotal = item.price_cents * item.quantity;
                subtotal += itemTotal;
                return `
                    <div class="flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0">
                        <div class="flex-1">
                            <p class="font-bold text-jd-black">${item.name}</p>
                            ${item.brand ? `<p class="text-sm text-gray-500">${item.brand}</p>` : ''}
                            <p class="text-sm text-gray-600">Cantidad: ${item.quantity}</p>
                        </div>
                        <p class="font-bold">‚Ç¨${(itemTotal / 100).toFixed(2)}</p>
                    </div>
                `;
            }).join('');

            container.innerHTML = itemsHtml;

            // Actualizar totales
            const shipping = subtotal >= 5000 ? 0 : 1000;
            const total = subtotal + shipping;

            const subtotalEl = document.getElementById('detail-subtotal');
            const shippingEl = document.getElementById('detail-shipping');
            const totalEl = document.getElementById('detail-total');

            if (subtotalEl) subtotalEl.textContent = `‚Ç¨${(subtotal / 100).toFixed(2)}`;
            if (shippingEl) {
                shippingEl.textContent = shipping === 0 ? 'GRATIS' : `‚Ç¨${(shipping / 100).toFixed(2)}`;
                shippingEl.className = shipping === 0 ? 'font-bold text-jd-turquoise' : 'font-bold';
            }
            if (totalEl) totalEl.textContent = `‚Ç¨${(total / 100).toFixed(2)}`;
        }

        // Generar PDF de factura
        async function generateInvoicePDF() {
            try {
                // Importar jsPDF din√°micamente
                const { jsPDF } = await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
                
                const doc = new jsPDF();
                const cart = getCart();
                
                let y = 20;
                
                // Header
                doc.setFontSize(20);
                doc.text('FACTURA', 20, y);
                y += 15;
                
                doc.setFontSize(10);
                doc.text('JGMarket - Fashion Store', 20, y);
                y += 5;
                doc.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 20, y);
                y += 5;
                doc.text(`Ref. Pedido: ${SESSION_ID?.substring(0, 12) || 'N/A'}`, 20, y);
                y += 15;
                
                // Items
                doc.setFontSize(10);
                doc.text('DETALLES DEL PEDIDO', 20, y);
                y += 8;
                
                let subtotal = 0;
                cart.forEach((item: any, index: number) => {
                    const itemTotal = item.price_cents * item.quantity;
                    subtotal += itemTotal;
                    
                    doc.text(`${index + 1}. ${item.name}`, 20, y);
                    doc.text(`   ${item.quantity} x ‚Ç¨${(item.price_cents / 100).toFixed(2)} = ‚Ç¨${(itemTotal / 100).toFixed(2)}`, 20, y + 5);
                    y += 10;
                });
                
                y += 5;
                const shipping = subtotal >= 5000 ? 0 : 1000;
                const total = subtotal + shipping;
                
                doc.line(20, y, 190, y);
                y += 5;
                
                doc.text(`Subtotal: ‚Ç¨${(subtotal / 100).toFixed(2)}`, 20, y);
                y += 5;
                doc.text(`Env√≠o: ‚Ç¨${(shipping / 100).toFixed(2)}`, 20, y);
                y += 8;
                
                doc.setFontSize(12);
                doc.text(`TOTAL: ‚Ç¨${(total / 100).toFixed(2)}`, 20, y);
                
                doc.save(`factura-${SESSION_ID?.substring(0, 12) || 'pedido'}.pdf`);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error al descargar la factura. Intenta de nuevo.');
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            renderOrderDetails();
            clearCart();
            
            // Event listener para descargar factura
            const downloadBtn = document.getElementById('download-invoice-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', generateInvoicePDF);
            }
        });
    </script>
</PublicLayout>
