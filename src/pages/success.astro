---
/**
 * src/pages/success.astro
 * Página de confirmación de pago exitoso
 */

import PublicLayout from "../layouts/PublicLayout.astro";

const sessionId = Astro.url.searchParams.get('session_id');
---

<PublicLayout title="Pago Completado - JGMarket">
    <div class="bg-jd-gray min-h-screen">
        <div class="max-w-2xl mx-auto px-4 py-12">
            <!-- Success Header -->
            <div class="bg-white rounded-lg p-8 text-center mb-8">
                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                </div>
                <h1 class="text-3xl font-black text-jd-black mb-2">¡Pago Completado!</h1>
                <p class="text-gray-600 mb-4">Tu pedido ha sido confirmado exitosamente</p>
            </div>

            <!-- Order Details -->
            <div class="bg-white rounded-lg p-8 mb-8">
                <h2 class="text-xl font-bold text-jd-black mb-6 uppercase">Detalles del Pedido</h2>
                
                <div id="order-details" class="space-y-4 mb-6">
                    <div class="flex justify-between py-2 border-b border-gray-200">
                        <span class="text-gray-600">Subtotal</span>
                        <span id="detail-subtotal" class="font-bold">€0.00</span>
                    </div>
                    <div class="flex justify-between py-2 border-b border-gray-200">
                        <span class="text-gray-600">Envío</span>
                        <span id="detail-shipping" class="font-bold text-jd-turquoise">GRATIS</span>
                    </div>
                    <div class="flex justify-between py-3 text-lg font-bold">
                        <span>Total</span>
                        <span id="detail-total" class="text-jd-red">€0.00</span>
                    </div>
                </div>

                <div id="items-container" class="border-t border-gray-200 pt-6 space-y-4">
                    <!-- Items will be rendered here -->
                </div>
            </div>

            <!-- Actions -->
            <div class="space-y-4">
                <button 
                    id="download-invoice-btn"
                    class="w-full bg-jd-turquoise text-white font-bold py-3 rounded uppercase hover:bg-opacity-90 transition"
                >
                    Descargar Factura (PDF)
                </button>
                
                <a 
                    href="/account#orders"
                    class="block text-center bg-jd-black text-white font-bold py-3 rounded uppercase hover:bg-opacity-90 transition"
                >
                    Ver Mis Pedidos
                </a>

                <a 
                    href="/productos"
                    class="block text-center bg-white text-jd-black font-bold py-3 rounded uppercase border-2 border-jd-black hover:bg-gray-100 transition"
                >
                    Continuar Comprando
                </a>
            </div>

            <!-- Info Message -->
            <div class="mt-8 bg-blue-50 border border-blue-200 rounded p-4 text-sm text-gray-700">
                <p class="font-bold text-blue-900 mb-2">ℹ️ Información Importante</p>
                <ul class="list-disc list-inside space-y-1">
                    <li>Tu carrito ha sido vaciado automáticamente</li>
                    <li>Recibirás un email de confirmación en breve</li>
                    <li>Tu pedido está disponible en la sección "Mis Pedidos"</li>
                    <li>Tiempo de entrega: 3-5 días laborales</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Datos del carrito antes de pagar
        const CART_KEY = 'fashionmarket_cart';
        
        // Obtener SESSION_ID directamente de la URL
        const urlParams = new URLSearchParams(window.location.search);
        let SESSION_ID = urlParams.get('session_id');
        
        // Si no viene en URL, intentar del localStorage
        if (!SESSION_ID) {
            SESSION_ID = localStorage.getItem('stripe_session_id');
        }
        
        console.log('Session ID:', SESSION_ID);

        function getCart() {
            const stored = localStorage.getItem(CART_KEY);
            if (!stored) return [];
            
            try {
                const parsed = JSON.parse(stored);
                if (parsed.items && Array.isArray(parsed.items)) {
                    return parsed.items;
                }
                return Array.isArray(parsed) ? parsed : [];
            } catch {
                return [];
            }
        }

        function clearCart() {
            localStorage.removeItem(CART_KEY);
            console.log('Carrito vaciado');
        }

        function renderOrderDetails() {
            const cart = getCart();
            const container = document.getElementById('items-container');
            
            if (!container || cart.length === 0) return;

            let subtotal = 0;
            
            const itemsHtml = cart.map((item: any) => {
                const itemTotal = item.price_cents * item.quantity;
                subtotal += itemTotal;
                return `
                    <div class="flex justify-between items-center py-3 border-b border-gray-100 last:border-b-0">
                        <div class="flex-1">
                            <p class="font-bold text-jd-black">${item.name}</p>
                            ${item.brand ? `<p class="text-sm text-gray-500">${item.brand}</p>` : ''}
                            <p class="text-sm text-gray-600">Cantidad: ${item.quantity}</p>
                        </div>
                        <p class="font-bold">€${(itemTotal / 100).toFixed(2)}</p>
                    </div>
                `;
            }).join('');

            container.innerHTML = itemsHtml;

            // Actualizar totales
            const shipping = subtotal >= 5000 ? 0 : 1000;
            const total = subtotal + shipping;

            const subtotalEl = document.getElementById('detail-subtotal');
            const shippingEl = document.getElementById('detail-shipping');
            const totalEl = document.getElementById('detail-total');

            if (subtotalEl) subtotalEl.textContent = `€${(subtotal / 100).toFixed(2)}`;
            if (shippingEl) {
                shippingEl.textContent = shipping === 0 ? 'GRATIS' : `€${(shipping / 100).toFixed(2)}`;
                shippingEl.className = shipping === 0 ? 'font-bold text-jd-turquoise' : 'font-bold';
            }
            if (totalEl) totalEl.textContent = `€${(total / 100).toFixed(2)}`;
        }

        // Generar PDF de factura
        async function generateInvoicePDF() {
            try {
                if (!SESSION_ID) {
                    alert('No se pudo obtener el ID de la sesión. Intenta nuevamente.');
                    return;
                }
                
                console.log('Downloading invoice for session:', SESSION_ID);
                
                // Redirigir al nuevo endpoint de factura que muestra HTML con botones de descarga
                window.location.href = `/pdf/invoice?id=${encodeURIComponent(SESSION_ID)}`;
                
                alert('Factura descargada. Puedes imprimirla a PDF desde el navegador.');
            } catch (error) {
                console.error('Error generating invoice:', error);
                alert('Error al descargar la factura. Intenta de nuevo.');
            }
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', () => {
            renderOrderDetails();
            clearCart();
            
            // Event listener para descargar factura
            const downloadBtn = document.getElementById('download-invoice-btn');
            if (downloadBtn) {
                downloadBtn.addEventListener('click', generateInvoicePDF);
            }
        });
    </script>
</PublicLayout>
