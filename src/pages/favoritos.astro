---
/**
 * src/pages/favoritos.astro
 * Página de productos favoritos
 */

import PublicLayout from '../layouts/PublicLayout.astro';
import ProductCard from '../components/product/ProductCard.astro';
import { supabaseClient } from '../lib/supabase';

// Esta página debe renderizarse dinámicamente porque los favoritos están en localStorage
export const prerender = false;

// Obtener IDs de favoritos (simulado en el servidor, será completado en el cliente)
let favoriteProducts = [];
---

<PublicLayout title="Mis Favoritos - FashionMarket" description="Tus productos favoritos guardados">
  <div class="max-w-7xl mx-auto px-4 py-12">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 mb-8 text-sm text-gray-600">
      <a href="/" class="hover:text-jd-red">Inicio</a>
      <span>/</span>
      <span class="text-jd-black font-semibold">Mis Favoritos</span>
    </nav>

    <!-- Título -->
    <h1 class="text-3xl md:text-4xl font-black text-jd-black uppercase mb-8">
      Mis Favoritos
    </h1>

    <!-- Contenedor de favoritos (manejado por JavaScript) -->
    <div id="favorites-container" class="min-h-96">
      <!-- Los favoritos se cargarán aquí con JavaScript -->
      <div class="text-center py-12">
        <p class="text-gray-500 text-lg">Cargando tus favoritos...</p>
      </div>
    </div>
  </div>
</PublicLayout>

<script define:vars={{  }}>
  // Importar ProductCard dinámicamente para renderizar productos
  async function loadFavorites() {
    const container = document.getElementById('favorites-container');
    
    try {
      // Obtener favoritos del localStorage
      const favorites = JSON.parse(localStorage.getItem('favorites') || '{}');
      const favoriteIds = Object.keys(favorites);

      console.log('Favoritos guardados:', favorites);
      console.log('IDs de favoritos:', favoriteIds);

      if (favoriteIds.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12">
            <p class="text-gray-500 text-lg mb-4">No tienes productos en favoritos</p>
            <a href="/productos" class="inline-block px-6 py-3 bg-jd-red text-white font-bold uppercase hover:bg-jd-black transition">
              Ver productos
            </a>
          </div>
        `;
        return;
      }

      // Fetch para obtener los productos desde la API
      const response = await fetch('/api/productos?ids=' + favoriteIds.join(','));
      const products = await response.json();

      console.log('URL llamada:', '/api/productos?ids=' + favoriteIds.join(','));
      console.log('Response status:', response.status);
      console.log('Productos obtenidos:', products);

      if (products.length === 0) {
        container.innerHTML = `
          <div class="text-center py-12">
            <p class="text-gray-500 text-lg">No se encontraron tus productos favoritos</p>
          </div>
        `;
        return;
      }

      // Renderizar grid de productos
      let html = '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">';
      
      for (const product of products) {
        const price = (product.price_cents / 100).toFixed(2);
        const originalPrice = product.original_price_cents 
          ? (product.original_price_cents / 100).toFixed(2) 
          : null;
        const image = product.images?.[0] || null;
        const hasDiscount = originalPrice && originalPrice > price;
        const discountPercent = hasDiscount 
          ? Math.round((1 - price / originalPrice) * 100)
          : 0;

        html += `
          <article class="group bg-white rounded overflow-hidden transition hover:shadow-lg relative">
            <a href="/productos/${product.slug}" class="block relative aspect-square overflow-hidden bg-gray-100">
              ${image ? `
                <img 
                  src="${image}" 
                  alt="${product.name}"
                  class="w-full h-full object-cover object-center group-hover:scale-105 transition-transform duration-300"
                  loading="lazy"
                />
              ` : `
                <div class="w-full h-full flex items-center justify-center bg-gray-200">
                  <svg class="w-16 h-16 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                </div>
              `}
              
              <!-- Badge de descuento -->
              ${hasDiscount ? `
                <div class="absolute top-2 left-2">
                  <span class="px-2 py-1 bg-red-600 text-white text-xs font-bold uppercase">
                    -${discountPercent}%
                  </span>
                </div>
              ` : ''}

              <!-- Botón eliminar de favoritos -->
              <button 
                onclick="removeFavorite(event, '${product.id}')"
                class="absolute top-2 right-2 z-10 p-2 rounded-full bg-white shadow-md hover:shadow-lg transition-all hover:scale-110"
                title="Eliminar de favoritos"
              >
                <svg class="w-6 h-6 fill-red-600 text-red-600" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" fill="currentColor" />
                </svg>
              </button>

              <!-- Ver producto button -->
              <button
                onclick="window.location.href='/productos/${product.slug}'"
                class="view-product-btn absolute bottom-0 left-0 right-0 py-3 bg-cyan-500 text-white font-bold text-sm uppercase opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center border-0 cursor-pointer"
              >
                Ver Producto
              </button>
            </a>

            <!-- Info del producto -->
            <div class="p-3">
              ${product.brand ? `<span class="text-xs font-bold text-gray-500 uppercase">${product.brand}</span>` : ''}
              <h3 class="font-bold text-sm text-jd-black line-clamp-2 mt-1 group-hover:text-jd-red transition">
                <a href="/productos/${product.slug}">${product.name}</a>
              </h3>
              
              <!-- Precio -->
              <div class="mt-2 flex items-center gap-2">
                ${originalPrice && hasDiscount ? `
                  <span class="text-sm text-gray-400 line-through">€${originalPrice}</span>
                ` : ''}
                <span class="font-bold ${hasDiscount ? 'text-jd-red' : 'text-jd-black'}">
                  €${price}
                </span>
              </div>
            </div>
          </article>
        `;
      }
      
      html += '</div>';
      container.innerHTML = html;

    } catch (error) {
      console.error('Error cargando favoritos:', error);
      container.innerHTML = `
        <div class="text-center py-12">
          <p class="text-red-500 text-lg">Error al cargar tus favoritos</p>
        </div>
      `;
    }
  }

  // Función para eliminar de favoritos
  function removeFavorite(event, productId) {
    event.preventDefault();
    event.stopPropagation();
    
    const favorites = JSON.parse(localStorage.getItem('favorites') || '{}');
    delete favorites[productId];
    localStorage.setItem('favorites', JSON.stringify(favorites));
    
    // Recargar favoritos
    loadFavorites();
  }

  // Cargar favoritos cuando se carga la página
  loadFavorites();
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
