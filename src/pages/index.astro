---
/**
 * src/pages/index.astro
 * Homepage estilo JG Sports - Muestra rebajas y productos destacados
 */

import PublicLayout from "../layouts/PublicLayout.astro";
import ProductCard from "../components/product/ProductCard.astro";
import { supabaseClient } from "../lib/supabase";
import { createClient } from "@supabase/supabase-js";

// Verificar autenticación usando cookies HTTP del servidor
const accessToken = Astro.cookies.get("sb-access-token")?.value;
const isGuest = Astro.cookies.has("guest-session");

// Si hay un token de acceso, verificar que sea válido
let isAuthenticated = false;
if (accessToken) {
  try {
    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
    const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
    const serverClient = createClient(supabaseUrl, supabaseAnonKey);
    const {
      data: { user },
    } = await serverClient.auth.getUser(accessToken);
    isAuthenticated = !!user;
  } catch (error) {
    console.error("Error verificando token:", error);
    isAuthenticated = false;
  }
}

// La homepage es pública - sin redirección

// Obtener productos destacados
const { data: featuredProducts } = await supabaseClient
  .from("products")
  .select("*")
  .eq("featured", true)
  .eq("is_active", true)
  .limit(8);

// Obtener productos en oferta (los que tienen precio original)
const { data: saleProducts } = await supabaseClient
  .from("products")
  .select("*")
  .eq("is_active", true)
  .not("original_price_cents", "is", null)
  .limit(4);

const products = featuredProducts || [];
const onSale = saleProducts || [];
---

<PublicLayout title="JGMarket - Zapatillas y Ropa Deportiva">
  <!-- Hero Banner -->
  <section
    class="relative bg-gradient-to-r from-jd-red to-red-700 text-white overflow-hidden"
  >
    <div class="absolute inset-0 opacity-20 pointer-events-none">
      <div
        class="absolute top-0 right-0 w-96 h-96 bg-black rounded-full mix-blend-multiply blur-3xl transform translate-x-1/2 -translate-y-1/2"
      >
      </div>
    </div>
  </section>

  <!-- Categories Grid -->
  <section class="max-w-7xl mx-auto px-4 py-12">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <a
        href="/productos?categoria=zapatillas"
        class="group relative bg-jd-black rounded overflow-hidden aspect-square"
        style="background-image: url('https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=500&h=500&fit=crop'); background-size: cover; background-position: center;"
      >
        <div
          class="absolute inset-0 bg-gradient-to-t from-jd-black to-transparent opacity-70"
        >
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
          <h3
            class="text-xl font-black uppercase group-hover:text-jd-turquoise transition"
          >
            Zapatillas
          </h3>
          <span class="text-sm opacity-75">Ver Colección →</span>
        </div>
      </a>
      <a
        href="/productos?categoria=ropa"
        class="group relative bg-jd-darkGray rounded overflow-hidden aspect-square"
        style="background-image: url('https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=500&h=500&fit=crop'); background-size: cover; background-position: center;"
      >
        <div
          class="absolute inset-0 bg-gradient-to-t from-jd-black to-transparent opacity-70"
        >
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
          <h3
            class="text-xl font-black uppercase group-hover:text-jd-turquoise transition"
          >
            Ropa
          </h3>
          <span class="text-sm opacity-75">Ver Colección →</span>
        </div>
      </a>
      <a
        href="/productos?categoria=accesorios"
        class="group relative bg-gray-700 rounded overflow-hidden aspect-square"
        style="background-image: url('https://images.unsplash.com/photo-1572635196237-14b3f281503f?w=500&h=500&fit=crop'); background-size: cover; background-position: center;"
      >
        <div
          class="absolute inset-0 bg-gradient-to-t from-jd-black to-transparent opacity-70"
        >
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
          <h3
            class="text-xl font-black uppercase group-hover:text-jd-turquoise transition"
          >
            Accesorios
          </h3>
          <span class="text-sm opacity-75">Ver Colección →</span>
        </div>
      </a>
      <a
        href="/productos"
        class="group relative bg-jd-red rounded overflow-hidden aspect-square"
        style="background-image: url('https://images.unsplash.com/photo-1553062407-98eeb64c6a62?w=500&h=500&fit=crop'); background-size: cover; background-position: center;"
      >
        <div
          class="absolute inset-0 bg-gradient-to-t from-red-900 to-transparent opacity-70"
        >
        </div>
        <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
          <h3
            class="text-xl font-black uppercase group-hover:text-jd-yellow transition"
          >
            Rebajas
          </h3>
          <span class="text-sm opacity-75">Hasta -50% →</span>
        </div>
      </a>
    </div>
  </section>

  <!-- Featured Products -->
  <section class="max-w-7xl mx-auto px-4 py-12">
    <div class="flex items-center justify-between mb-8">
      <h2 class="text-2xl md:text-3xl font-black text-jd-black uppercase">
        Lo Más Vendido
      </h2>
      <a
        href="/productos"
        class="text-sm font-bold text-jd-red uppercase hover:text-jd-black transition"
      >
        Ver Todo →
      </a>
    </div>

    {
      products.length > 0 ? (
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
          {products.map((product) => (
            <ProductCard
              id={product.id}
              name={product.name}
              slug={product.slug}
              price={product.price_cents}
              originalPrice={product.original_price_cents}
              image={product.images?.[0]}
              stock={product.stock}
              featured={product.featured}
              brand={product.brand}
            />
          ))}
        </div>
      ) : (
        <div class="text-center py-12 bg-white rounded">
          <p class="text-gray-500">Próximamente productos destacados</p>
        </div>
      )
    }
  </section>

  <!-- Brand Banner -->
  <section class="bg-jd-black py-16">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div
          class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-lg p-8 text-white"
        >
          <span class="text-sm font-bold uppercase opacity-75">Nike</span>
          <h3 class="text-3xl font-black uppercase mt-2 mb-4">Air Max</h3>
          <p class="opacity-90 mb-6">Descubre la nueva colección Air Max</p>
          <a
            href="/marcas/nike"
            style="display: inline-block; padding: 0.75rem 1.5rem; background-color: white; color: #000; font-weight: bold; text-transform: uppercase; font-size: 0.875rem; border-radius: 0.375rem; text-decoration: none;"
          >
            Comprar Ahora
          </a>
        </div>
        <div
          class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg p-8 text-white"
        >
          <span class="text-sm font-bold uppercase opacity-75">Adidas</span>
          <h3 class="text-3xl font-black uppercase mt-2 mb-4">Originals</h3>
          <p class="opacity-90 mb-6">Clásicos que nunca pasan de moda</p>
          <a
            href="/marcas/adidas"
            style="display: inline-block; padding: 0.75rem 1.5rem; background-color: white; color: #000; font-weight: bold; text-transform: uppercase; font-size: 0.875rem; border-radius: 0.375rem; text-decoration: none;"
          >
            Comprar Ahora
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Sale Products -->
  <section class="max-w-7xl mx-auto px-4 py-12">
    <div class="flex items-center justify-between mb-8">
      <div class="flex items-center gap-4">
        <h2 class="text-2xl md:text-3xl font-black text-jd-red uppercase">
          Rebajas
        </h2>
        <span class="px-3 py-1 bg-jd-red text-white text-xs font-bold uppercase"
          >Hasta -50%</span
        >
      </div>
      <a
        href="/productos"
        class="text-sm font-bold text-jd-black uppercase hover:text-jd-red transition"
      >
        Ver Todo →
      </a>
    </div>

    {
      onSale.length > 0 ? (
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
          {onSale.map((product) => (
            <ProductCard
              id={product.id}
              name={product.name}
              slug={product.slug}
              price={product.price_cents}
              originalPrice={product.original_price_cents}
              image={product.images?.[0]}
              stock={product.stock}
              featured={product.featured}
              brand={product.brand}
              onSale={true}
            />
          ))}
        </div>
      ) : (
        <div class="text-center py-12 bg-white rounded">
          <p class="text-gray-500">Próximamente ofertas especiales</p>
        </div>
      )
    }
  </section>

  <!-- USP Section -->
  <section class="bg-white py-12 border-t border-gray-200">
    <div class="max-w-7xl mx-auto px-4">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
        <div class="text-center">
          <div
            class="w-12 h-12 bg-jd-turquoise rounded-full flex items-center justify-center mx-auto mb-3"
          >
            <svg
              class="w-6 h-6 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"
              ></path>
            </svg>
          </div>
          <h4 class="font-bold text-sm uppercase">Envío Gratis</h4>
          <p class="text-xs text-gray-500 mt-1">En pedidos +50€</p>
        </div>
        <div class="text-center">
          <div
            class="w-12 h-12 bg-jd-turquoise rounded-full flex items-center justify-center mx-auto mb-3"
          >
            <svg
              class="w-6 h-6 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              ></path>
            </svg>
          </div>
          <h4 class="font-bold text-sm uppercase">Devolución 60 días</h4>
          <p class="text-xs text-gray-500 mt-1">Sin preguntas</p>
        </div>
        <div class="text-center">
          <div
            class="w-12 h-12 bg-jd-turquoise rounded-full flex items-center justify-center mx-auto mb-3"
          >
            <svg
              class="w-6 h-6 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
              ></path>
            </svg>
          </div>
          <h4 class="font-bold text-sm uppercase">Pago Seguro</h4>
          <p class="text-xs text-gray-500 mt-1">100% protegido</p>
        </div>
        <div class="text-center">
          <div
            class="w-12 h-12 bg-jd-turquoise rounded-full flex items-center justify-center mx-auto mb-3"
          >
            <svg
              class="w-6 h-6 text-white"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"
              ></path>
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
          </div>
          <h4 class="font-bold text-sm uppercase">Recogida en Tienda</h4>
          <p class="text-xs text-gray-500 mt-1">Mismo día</p>
        </div>
      </div>
    </div>
  </section>
</PublicLayout>
