---
/**
 * src/pages/account.astro
 * P√°gina de cuenta del usuario autenticado
 * Muestra informaci√≥n de la cuenta y opciones de configuraci√≥n
 */

import PublicLayout from '../layouts/PublicLayout.astro';
import { EditProfileModal, ChangePasswordModal, ChangeEmailModal, DeleteAccountModal, AddAddressModal } from '../components/islands/AccountModals';
---

<PublicLayout title="Mi Cuenta - JGMarket">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Title -->
    <div class="mb-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-2">Mi Cuenta</h1>
      <p class="text-gray-600">Gestiona la informaci√≥n de tu perfil y seguridad</p>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <!-- Sidebar Navigation -->
      <div class="md:col-span-1">
        <nav class="bg-white rounded-lg shadow-sm p-6 space-y-2 h-fit sticky top-24">
          <a href="#profile" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition nav-link" data-section="profile">
            Informaci√≥n Personal
          </a>
          <a href="#security" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition nav-link" data-section="security">
            Seguridad
          </a>
          <a href="#orders" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition nav-link" data-section="orders">
            Mis Pedidos
          </a>
          <a href="#addresses" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition nav-link" data-section="addresses">
            Mis Direcciones
          </a>
        </nav>
      </div>

      <!-- Content Area -->
      <div class="md:col-span-2">
        <!-- Profile Section -->
        <section id="profile" class="section bg-white rounded-lg shadow-sm p-8 mb-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Informaci√≥n Personal</h2>
          
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Correo Electr√≥nico</label>
              <p id="userEmail" class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-900">
                Cargando...
              </p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de Usuario</label>
              <p id="userName" class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-900">
                No configurado
              </p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Registro</label>
              <p id="userCreated" class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-900">
                Cargando...
              </p>
            </div>

            <EditProfileModal client:load />
          </div>
        </section>

        <!-- Security Section -->
        <section id="security" class="section bg-white rounded-lg shadow-sm p-8 mb-6 hidden">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Seguridad</h2>
          
          <div class="space-y-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
              <p class="text-sm text-blue-900">Protege tu cuenta con una contrase√±a segura</p>
            </div>

            <ChangePasswordModal client:load />

            <ChangeEmailModal client:load />

            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mt-8 pt-6">
              <h3 class="font-bold text-red-900 mb-3">Zona Peligrosa</h3>
              <DeleteAccountModal client:load />
            </div>
          </div>
        </section>

        <!-- Orders Section -->
        <section id="orders" class="section bg-white rounded-lg shadow-sm p-8 mb-6 hidden">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Mis Pedidos</h2>
          <p class="text-gray-600 mb-6">Aqu√≠ aparecer√°n tus pedidos cuando realices tu primera compra</p>
          
          <div id="ordersContainer" class="space-y-4">
            <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
              <p class="text-gray-500 mb-3">Cargando pedidos...</p>
            </div>
          </div>
        </section>

        <!-- Addresses Section -->
        <section id="addresses" class="section bg-white rounded-lg shadow-sm p-8 mb-6 hidden">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Mis Direcciones</h2>
          
          <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
            <p class="text-gray-500 mb-3">Sin direcciones guardadas</p>
            <AddAddressModal client:load />
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // Proteger p√°gina - redirigir si no est√° autenticado
    function checkAuthentication() {
      const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
      const isGuest = localStorage.getItem('isGuest') === 'true';
      
      console.log('üìÑ Verificando autenticaci√≥n en /account:', {
        isAuthenticated,
        isGuest
      });
      
      if (!isAuthenticated || isGuest) {
        console.log('‚ùå No autenticado - redirigiendo a /login');
        window.location.href = '/login';
        return;
      }
      
      console.log('‚úÖ Autenticado - mostrando contenido de /account');
      loadUserInfo();
    }
    
    // Verificar autenticaci√≥n al cargar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkAuthentication);
    } else {
      checkAuthentication();
    }
    
    // Cargar informaci√≥n del usuario
    async function loadUserInfo() {
      try {
        const { supabaseClient } = await import('../lib/supabase');
        const { data: { session } } = await supabaseClient.auth.getSession();
        
        if (!session) {
          window.location.href = '/login';
          return;
        }

        // Mostrar informaci√≥n del usuario de forma segura
        const userEmailEl = document.getElementById('userEmail');
        const userNameEl = document.getElementById('userName');
        const userCreatedEl = document.getElementById('userCreated');
        
        if (userEmailEl) userEmailEl.textContent = session.user.email || 'No disponible';
        
        // Traer el username desde la tabla users
        if (userNameEl) {
          const { data: userData, error } = await supabaseClient
            .from('users')
            .select('username')
            .eq('id', session.user.id)
            .single();
          
          if (userData && userData.username) {
            userNameEl.textContent = userData.username;
          } else {
            userNameEl.textContent = 'No configurado';
          }
        }
        
        if (userCreatedEl) {
          const createdDate = new Date(session.user.created_at).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
          userCreatedEl.textContent = createdDate;
        }

        // Cargar √≥rdenes del usuario (independiente de otros errores)
        loadUserOrders(supabaseClient, session.user.id);
      } catch (error) {
        console.error('Error loading user info:', error);
        // Intentar cargar √≥rdenes de todas formas
        try {
          const { supabaseClient } = await import('../lib/supabase');
          const { data: { session } } = await supabaseClient.auth.getSession();
          if (session) {
            loadUserOrders(supabaseClient, session.user.id);
          }
        } catch (e) {
          console.error('Error loading orders after error:', e);
        }
      }
    }

    // Cargar √≥rdenes del usuario
    async function loadUserOrders(supabaseClient: any, userId: string) {
      console.log('üîÑ loadUserOrders() iniciada para userId:', userId);
      try {
        // Obtener el token de autenticaci√≥n
        const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
        
        if (sessionError || !session?.access_token) {
          console.error('‚ùå No hay sesi√≥n de autenticaci√≥n');
          return;
        }

        console.log('‚úÖ Session encontrada con token');

        // Crear cliente autenticado con el token
        const { createClient } = await import('@supabase/supabase-js');
        const supabaseAuth = createClient(
          import.meta.env.PUBLIC_SUPABASE_URL,
          import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
          {
            global: {
              headers: {
                authorization: `Bearer ${session.access_token}`,
              },
            },
          }
        );

        console.log('üîç Consultando √≥rdenes para userId:', userId);
        const { data: orders, error } = await supabaseAuth
          .from('orders')
          .select('*')
          .eq('user_id', userId)
          .order('created_at', { ascending: false });

        console.log('üì¶ Respuesta de √≥rdenes:', { orders, error });

        const ordersContainer = document.getElementById('ordersContainer');
        if (!ordersContainer) return;

        if (error) {
          console.error('Error loading orders:', error);
          ordersContainer.innerHTML = `
            <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
              <p class="text-gray-500 mb-3">Sin pedidos a√∫n</p>
              <a href="/productos" class="inline-block px-6 py-2 bg-jd-red text-white font-semibold rounded-lg hover:bg-red-700 transition">
                Ir a Comprar
              </a>
            </div>
          `;
          return;
        }

        if (!orders || orders.length === 0) {
          ordersContainer.innerHTML = `
            <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
              <p class="text-gray-500 mb-3">Sin pedidos a√∫n</p>
              <a href="/productos" class="inline-block px-6 py-2 bg-jd-red text-white font-semibold rounded-lg hover:bg-red-700 transition">
                Ir a Comprar
              </a>
            </div>
          `;
          return;
        }

        // Mostrar las √≥rdenes
        const ordersHTML = orders.map((order: any) => {
          const createdDate = new Date(order.created_at).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
          
          const statusMap: any = {
            'pending': { label: 'Pendiente', color: 'bg-yellow-100 text-yellow-800' },
            'confirmed': { label: 'Confirmado', color: 'bg-blue-100 text-blue-800' },
            'shipped': { label: 'Enviado', color: 'bg-purple-100 text-purple-800' },
            'delivered': { label: 'Entregado', color: 'bg-green-100 text-green-800' },
            'cancelled': { label: 'Cancelado', color: 'bg-red-100 text-red-800' }
          };

          const statusInfo = statusMap[order.status] || { label: order.status, color: 'bg-gray-100 text-gray-800' };
          const total = (order.total_cents / 100).toFixed(2);

          return `
            <div class="bg-white border border-gray-200 rounded-lg p-6 hover:shadow-md transition">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h3 class="text-lg font-semibold text-gray-900">Pedido #${order.order_number}</h3>
                  <p class="text-sm text-gray-600">${createdDate}</p>
                </div>
                <span class="px-3 py-1 rounded-full text-sm font-medium ${statusInfo.color}">
                  ${statusInfo.label}
                </span>
              </div>
              <div class="flex justify-between items-end">
                <div>
                  ${order.payment_method ? `<p class="text-sm text-gray-600">Pago: ${order.payment_method}</p>` : ''}
                  ${order.notes ? `<p class="text-sm text-gray-600 mt-1">${order.notes}</p>` : ''}
                </div>
                <p class="text-xl font-bold text-jd-red">$${total}</p>
              </div>
            </div>
          `;
        }).join('');

        ordersContainer.innerHTML = ordersHTML;
      } catch (error) {
        console.error('Error loading orders:', error);
      }
    }

    // Funciones de navegaci√≥n entre secciones
    document.querySelectorAll('.nav-link').forEach((link: any) => {
      link.addEventListener('click', (e: Event) => {
        e.preventDefault();
        
        // Ocultar todas las secciones
        document.querySelectorAll('.section').forEach((section: any) => {
          section.classList.add('hidden');
        });
        
        // Remover clase activa de todos los links
        document.querySelectorAll('.nav-link').forEach((l: any) => {
          l.classList.remove('bg-red-100', 'text-jd-red');
        });
        
        // Mostrar secci√≥n seleccionada
        const sectionId = (link as any).dataset.section;
        const targetSection = document.getElementById(sectionId);
        if (targetSection) targetSection.classList.remove('hidden');
        
        // Marcar link como activo
        link.classList.add('bg-red-100', 'text-jd-red');
      });
    });

    // Marcar primer link como activo
    const firstLink = document.querySelector('.nav-link');
    if (firstLink) firstLink.classList.add('bg-red-100', 'text-jd-red');

    // Cargar info del usuario cuando la p√°gina est√© lista
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadUserInfo);
    } else {
      loadUserInfo();
    }

    // Ocultar barra amarilla en esta p√°gina
    const promoBar = document.querySelector('.promo-bar') as HTMLElement;
    if (promoBar) {
      promoBar.style.display = 'none';
    }
  </script>

  <style>
    :global(.section) {
      transition: opacity 0.3s ease;
    }

    :global(.hidden) {
      display: none;
    }
  </style>
</PublicLayout>
