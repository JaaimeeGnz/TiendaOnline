---
/**
 * src/pages/account.astro
 * P√°gina de cuenta del usuario autenticado
 * Muestra informaci√≥n de la cuenta y opciones de configuraci√≥n
 */

import PublicLayout from '../layouts/PublicLayout.astro';
import { EditProfileModal, ChangePasswordModal, ChangeEmailModal, DeleteAccountModal, AddAddressModal } from '../components/islands/AccountModals';
---

<PublicLayout title="Mi Cuenta - JGMarket">
  <div class="max-w-4xl mx-auto px-4 py-12">
    <!-- Title -->
    <div class="mb-12">
      <h1 class="text-4xl font-bold text-gray-900 mb-2">Mi Cuenta</h1>
      <p class="text-gray-600">Gestiona la informaci√≥n de tu perfil y seguridad</p>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
      <!-- Sidebar Navigation -->
      <div class="md:col-span-1">
        <nav class="bg-white rounded-lg shadow-sm p-6 space-y-2 h-fit sticky top-24">
          <a href="#profile" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition nav-link" data-section="profile">
            Informaci√≥n Personal
          </a>
          <a href="#security" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition nav-link" data-section="security">
            Seguridad
          </a>
          <a href="#orders" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition nav-link" data-section="orders">
            Mis Pedidos
          </a>
          <a href="#addresses" class="block px-4 py-2 text-gray-700 hover:bg-gray-100 rounded-lg transition nav-link" data-section="addresses">
            Mis Direcciones
          </a>
        </nav>
      </div>

      <!-- Content Area -->
      <div class="md:col-span-2">
        <!-- Profile Section -->
        <section id="profile" class="section bg-white rounded-lg shadow-sm p-8 mb-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Informaci√≥n Personal</h2>
          
          <div class="space-y-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Correo Electr√≥nico</label>
              <p id="userEmail" class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-900">
                Cargando...
              </p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de Usuario</label>
              <p id="userName" class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-900">
                No configurado
              </p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Registro</label>
              <p id="userCreated" class="px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg text-gray-900">
                Cargando...
              </p>
            </div>

            <EditProfileModal client:load />
          </div>
        </section>

        <!-- Security Section -->
        <section id="security" class="section bg-white rounded-lg shadow-sm p-8 mb-6 hidden">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Seguridad</h2>
          
          <div class="space-y-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
              <p class="text-sm text-blue-900">Protege tu cuenta con una contrase√±a segura</p>
            </div>

            <ChangePasswordModal client:load />

            <ChangeEmailModal client:load />

            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mt-8 pt-6">
              <h3 class="font-bold text-red-900 mb-3">Zona Peligrosa</h3>
              <DeleteAccountModal client:load />
            </div>
          </div>
        </section>

        <!-- Orders Section -->
        <section id="orders" class="section bg-white rounded-lg shadow-sm p-8 mb-6 hidden">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Mis Pedidos</h2>
          <p class="text-gray-600 mb-6">Aqu√≠ aparecer√°n tus pedidos cuando realices tu primera compra</p>
          
          <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
            <p class="text-gray-500 mb-3">Sin pedidos a√∫n</p>
            <a href="/productos" class="inline-block px-6 py-2 bg-jd-red text-white font-semibold rounded-lg hover:bg-red-700 transition">
              Ir a Comprar
            </a>
          </div>
        </section>

        <!-- Addresses Section -->
        <section id="addresses" class="section bg-white rounded-lg shadow-sm p-8 mb-6 hidden">
          <h2 class="text-2xl font-bold text-gray-900 mb-6">Mis Direcciones</h2>
          
          <div class="bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-8 text-center mb-6">
            <p class="text-gray-500 mb-3">Sin direcciones guardadas</p>
            <AddAddressModal client:load />
          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // Proteger p√°gina - redirigir si no est√° autenticado
    function checkAuthentication() {
      const isAuthenticated = localStorage.getItem('isAuthenticated') === 'true';
      const isGuest = localStorage.getItem('isGuest') === 'true';
      
      console.log('üìÑ Verificando autenticaci√≥n en /account:', {
        isAuthenticated,
        isGuest
      });
      
      if (!isAuthenticated || isGuest) {
        console.log('‚ùå No autenticado - redirigiendo a /login');
        window.location.href = '/login';
        return;
      }
      
      console.log('‚úÖ Autenticado - mostrando contenido de /account');
      loadUserInfo();
    }
    
    // Verificar autenticaci√≥n al cargar
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', checkAuthentication);
    } else {
      checkAuthentication();
    }
    
    // Cargar informaci√≥n del usuario
    async function loadUserInfo() {
      try {
        const { supabaseClient } = await import('../lib/supabase');
        const { data: { session } } = await supabaseClient.auth.getSession();
        
        if (!session) {
          window.location.href = '/login';
          return;
        }

        // Mostrar informaci√≥n del usuario de forma segura
        const userEmailEl = document.getElementById('userEmail');
        const userNameEl = document.getElementById('userName');
        const userCreatedEl = document.getElementById('userCreated');
        
        if (userEmailEl) userEmailEl.textContent = session.user.email || 'No disponible';
        
        // Traer el username desde la tabla users
        if (userNameEl) {
          const { data: userData, error } = await supabaseClient
            .from('users')
            .select('username')
            .eq('id', session.user.id)
            .single();
          
          if (userData && userData.username) {
            userNameEl.textContent = userData.username;
          } else {
            userNameEl.textContent = 'No configurado';
          }
        }
        
        if (userCreatedEl) {
          const createdDate = new Date(session.user.created_at).toLocaleDateString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          });
          userCreatedEl.textContent = createdDate;
        }
      } catch (error) {
        console.error('Error loading user info:', error);
      }
    }

    // Funciones de navegaci√≥n entre secciones
    document.querySelectorAll('.nav-link').forEach((link: any) => {
      link.addEventListener('click', (e: Event) => {
        e.preventDefault();
        
        // Ocultar todas las secciones
        document.querySelectorAll('.section').forEach((section: any) => {
          section.classList.add('hidden');
        });
        
        // Remover clase activa de todos los links
        document.querySelectorAll('.nav-link').forEach((l: any) => {
          l.classList.remove('bg-red-100', 'text-jd-red');
        });
        
        // Mostrar secci√≥n seleccionada
        const sectionId = (link as any).dataset.section;
        const targetSection = document.getElementById(sectionId);
        if (targetSection) targetSection.classList.remove('hidden');
        
        // Marcar link como activo
        link.classList.add('bg-red-100', 'text-jd-red');
      });
    });

    // Marcar primer link como activo
    const firstLink = document.querySelector('.nav-link');
    if (firstLink) firstLink.classList.add('bg-red-100', 'text-jd-red');

    // Cargar info del usuario cuando la p√°gina est√© lista
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadUserInfo);
    } else {
      loadUserInfo();
    }

    // Ocultar barra amarilla en esta p√°gina
    const promoBar = document.querySelector('.promo-bar') as HTMLElement;
    if (promoBar) {
      promoBar.style.display = 'none';
    }
  </script>

  <style>
    :global(.section) {
      transition: opacity 0.3s ease;
    }

    :global(.hidden) {
      display: none;
    }
  </style>
</PublicLayout>
