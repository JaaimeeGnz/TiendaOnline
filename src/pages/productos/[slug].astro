---
/**
 * src/pages/productos/[slug].astro
 * Página de detalle de producto (SSG)
 */

import PublicLayout from '../../layouts/PublicLayout.astro';
import ProductGallery from '../../components/product/ProductGallery.astro';
import AddToCartButton from '../../components/islands/AddToCartButton';
import StockDisplay from '../../components/islands/StockDisplay';
import SizeRecommender from '../../components/islands/SizeRecommender';
import FavoriteButton from '../../components/product/FavoriteButton';
import { supabaseClient } from '../../lib/supabase';
import { formatPrice } from '../../lib/utils';

// Pre-renderizar la página como HTML estático
export const prerender = true;

// Obtener todos los productos para generar rutas estáticas
export async function getStaticPaths() {
  const { data: products } = await supabaseClient
    .from('products')
    .select('slug')
    .eq('is_active', true);

  return (products || []).map((prod) => ({
    params: { slug: prod.slug },
  }));
}

// Obtener slug del URL
const { slug } = Astro.params;

// Obtener producto
const { data: product } = await supabaseClient
  .from('products')
  .select('*')
  .eq('slug', slug)
  .eq('is_active', true)
  .single();

if (!product) {
  return Astro.redirect('/404');
}

// Obtener categoría
const { data: category } = await supabaseClient
  .from('categories')
  .select('*')
  .eq('id', product.category_id)
  .single();

const selectedSize = 'M';

// Determinar si es un producto de ropa (tiene lógica para recomendador de talla)
const clothingCategories = ['camisas', 'pantalones', 'trajes', 'vestidos', 'chaquetas', 'abrigos', 'sudaderas', 'camisetas', 'tops', 'faldas', 'leggings', 'ropa interior', 'calcetines', 'polos', 'ropa', 'cinturones'];
const isClothing = category && clothingCategories.some(cat => 
  category.name.toLowerCase().includes(cat) || 
  product.name.toLowerCase().includes(cat)
);
---

<PublicLayout
  title={`${product.name} - FashionMarket`}
  description={product.description}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 mb-8 text-sm text-neutral-gray_dark">
      <a href="/" class="hover:text-primary-800">Inicio</a>
      <span>/</span>
      <a href="/productos" class="hover:text-primary-800">Productos</a>
      <span>/</span>
      {category && (
        <>
          <a href={`/categoria/${category.slug}`} class="hover:text-primary-800">
            {category.name}
          </a>
          <span>/</span>
        </>
      )}
      <span class="text-primary-800 font-semibold">{product.name}</span>
    </nav>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
      <!-- Galería de imágenes -->
      <div>
        <ProductGallery images={product.images} productName={product.name} />
      </div>

      <!-- Detalles del producto -->
      <div class="space-y-8 relative">
        <!-- Botón de favorito -->
        <div class="absolute top-0 right-0">
          <FavoriteButton client:load productId={product.id} productName={product.name} />
        </div>

        <!-- Nombre y precio -->
        <div>
          <div class="flex items-center gap-4 mb-3">
            {category && (
              <a
                href={`/categoria/${category.slug}`}
                class="text-xs font-semibold text-primary-600 uppercase tracking-wider hover:text-primary-800"
              >
                {category.name}
              </a>
            )}
            {product.featured && (
              <span class="text-xs font-bold text-accent-gold uppercase">DESTACADO</span>
            )}
          </div>
          <h1 class="font-serif text-4xl font-bold text-primary-800 mb-4">
            {product.name}
          </h1>
          <p class="text-3xl font-bold text-neutral-gray_dark">
            {formatPrice(product.price_cents)}
          </p>
        </div>

        <!-- Estado de stock -->
        <StockDisplay client:load productId={product.id} initialStock={product.stock} />

        <!-- Descripción -->
        <div>
          <h2 class="font-serif text-lg font-bold text-primary-800 mb-3">
            Descripción
          </h2>
          <p class="text-neutral-gray_dark leading-relaxed">
            {product.description}
          </p>
        </div>

        <!-- Características -->
        {(product.material || product.color || product.sizes) && (
          <div>
            <h2 class="font-serif text-lg font-bold text-primary-800 mb-3">
              Características
            </h2>
            <ul class="space-y-2 text-sm text-neutral-gray_dark">
              {product.material && <li><strong>Material:</strong> {product.material}</li>}
              {product.color && <li><strong>Color:</strong> {product.color}</li>}
              {product.sizes && (
                <li><strong>Tallas:</strong> {product.sizes.join(', ')}</li>
              )}
            </ul>
          </div>
        )}

        <!-- Selector de talla y botón de compra -->
        <div class="space-y-4">
          <div>
            <div class="flex items-center justify-between mb-2">
              <label for="size" class="block text-sm font-semibold text-primary-800">
                Seleccionar talla:
              </label>
              {isClothing && (
                <button
                  type="button"
                  onclick="window.openSizeRecommenderModal?.()"
                  class="text-xs text-jd-turquoise font-bold hover:underline flex items-center gap-1"
                >
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.540-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                  ¿Cuál es mi talla?
                </button>
              )}
            </div>
            {product.sizes && product.sizes.length > 0 ? (
              <select
                id="size"
                class="w-full px-4 py-2 border border-primary-300 rounded-sm text-sm focus:outline-none focus:border-primary-800"
              >
                <option value="">-- Elige una talla --</option>
                {product.sizes?.map((size: string) => (
                  <option value={size}>{size}</option>
                ))}
              </select>
            ) : (
              <p class="text-sm text-neutral-gray">Este producto no tiene opciones de talla.</p>
            )}
          </div>

          <!-- Size Recommender Modal -->
          <SizeRecommender client:load isOpen={false} productName={product.name} />

          <!-- Botón Añadir al Carrito (isla React) -->
          <AddToCartButton
            client:load
            productId={product.id}
            productName={product.name}
            productSlug={product.slug}
            price={product.price_cents}
            stock={product.stock}
            selectedSize={selectedSize}
            imageUrl={product.images?.[0]}
          />
        </div>

        <!-- Información adicional -->
        <div class="pt-8 border-t border-primary-200 space-y-4 text-sm text-neutral-gray_dark">
          <p>
            <strong>SKU:</strong> {product.sku || 'N/A'}
          </p>
          <p>
            Envíos rápidos y devoluciones gratuitas en 30 días.
          </p>
        </div>
      </div>
    </div>
  </div>
</PublicLayout>

<script define:vars={{ sizes: product.sizes || [] }}>
  const sizeSelect = document.getElementById('size');
  if (sizeSelect && sizes.length > 0) {
    // Set the first size as selected
    sizeSelect.value = sizes[0];

    // Update the AddToCartButton's selectedSize
    sizeSelect.addEventListener('change', (e) => {
      // This would be handled by React component in real scenario
      console.log('Size changed to:', e.target.value);
    });
  }
</script>
