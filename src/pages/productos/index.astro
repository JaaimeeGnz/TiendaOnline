---
/**
 * src/pages/productos/index.astro
 * Página de productos estilo JD Sports
 */

import PublicLayout from "../../layouts/PublicLayout.astro";
import ProductCard from "../../components/product/ProductCard.astro";
import ProductFilters from "../../components/islands/ProductFilters";
import { supabaseClient } from "../../lib/supabase";

// Obtener parámetro de categoría
const url = new URL(Astro.request.url);
const categorySlug = url.searchParams.get("categoria");

// Obtener categorías principales (sin parent)
const { data: mainCategories } = await supabaseClient
  .from("categories")
  .select("*")
  .is("parent_id", null)
  .eq("is_active", true)
  .order("display_order");

let products = [];
let categoryName = "";
let pageTitle = "Todos los Productos";
let mainCategoryId: string | null = null;
let subcategories: any[] = [];

if (categorySlug) {
  // Obtener categoría (puede ser principal o subcategoría)
  const { data: category } = await supabaseClient
    .from("categories")
    .select("*")
    .eq("slug", categorySlug)
    .eq("is_active", true)
    .single();

  if (category) {
    categoryName = category.name;
    pageTitle = category.name;

    // Si es una subcategoría (tiene parent_id), obtener productos de esa subcategoría
    if (category.parent_id) {
      mainCategoryId = category.parent_id;
      const { data: categoryProducts } = await supabaseClient
        .from("products")
        .select("*")
        .eq("category_id", category.id)
        .eq("is_active", true)
        .order("featured", { ascending: false })
        .order("created_at", { ascending: false });

      products = categoryProducts || [];

      // Obtener subcategorías del padre para mostrar en el filtro
      const { data: subs } = await supabaseClient
        .from("categories")
        .select("*")
        .eq("parent_id", mainCategoryId)
        .eq("is_active", true)
        .order("display_order");
      
      subcategories = subs || [];
    } else {
      // Si es una categoría principal, obtener todos los productos de todas sus subcategorías
      mainCategoryId = category.id;
      
      // Obtener subcategorías
      const { data: subs } = await supabaseClient
        .from("categories")
        .select("*")
        .eq("parent_id", category.id)
        .eq("is_active", true)
        .order("display_order");
      
      subcategories = subs || [];

      // Obtener productos de todas las subcategorías
      if (subcategories.length > 0) {
        const subIds = subcategories.map(s => s.id);
        const { data: categoryProducts } = await supabaseClient
          .from("products")
          .select("*")
          .in("category_id", subIds)
          .eq("is_active", true)
          .order("featured", { ascending: false })
          .order("created_at", { ascending: false });

        products = categoryProducts || [];
      }
    }
  }
} else {
  const { data: allProducts } = await supabaseClient
    .from("products")
    .select("*")
    .eq("is_active", true)
    .order("featured", { ascending: false })
    .order("created_at", { ascending: false });

  products = allProducts || [];
}

// Obtener marcas únicas para filtros
const uniqueBrands = [...new Set(products.map((p) => p.brand).filter(Boolean))];
---

<PublicLayout title={`${pageTitle} - JGMarket`}>
  <div class="bg-jd-gray min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 mb-6 text-sm text-gray-500">
        <a href="/" class="hover:text-jd-black transition">Inicio</a>
        <span>/</span>
        <a href="/productos" class="hover:text-jd-black transition">Productos</a
        >
        {
          categoryName && (
            <>
              <span>/</span>
              <span class="text-jd-black font-bold">{categoryName}</span>
            </>
          )
        }
      </nav>

      <!-- Header -->
      <div
        class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8"
      >
        <div>
          <h1 class="text-3xl md:text-4xl font-black text-jd-black uppercase">
            {pageTitle}
          </h1>
          <p class="text-gray-500 mt-1">{products.length} productos disponibles</p>
        </div>
      </div>

      <ProductFilters client:load products={products} brands={uniqueBrands} />
    </div>
  </div>
</PublicLayout>
