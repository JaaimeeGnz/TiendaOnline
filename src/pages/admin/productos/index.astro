---
/**
 * src/pages/admin/productos/index.astro
 * Listado de productos para admin
 */

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { formatPrice } from '../../../lib/utils';
---

<AdminLayout title="Gestión de Productos">
  <div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-4xl font-black text-jd-black">Productos</h1>
        <p class="text-gray-600 mt-2 font-semibold">Gestiona tu catálogo de productos</p>
      </div>
      <div class="flex gap-3">
        <a
          href="/admin/productos/nuevo"
          class="inline-flex items-center gap-2 px-6 py-3 bg-jd-red text-white font-bold rounded-lg hover:bg-red-700 active:scale-95 transition duration-200"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Nuevo Producto
        </a>
      </div>
    </div>

    <!-- Loading state -->
    <div id="loading" class="flex justify-center py-12">
      <div class="text-center">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-gray-600">Cargando productos...</p>
      </div>
    </div>

    <!-- Products table -->
    <div id="content" class="hidden">
      <div id="products-container"></div>
    </div>
  </div>

  <script>
    (async () => {
      try {
        const { supabaseClient } = await import('../../../lib/supabase.ts');
        
        const { data: products } = await supabaseClient
          .from('products')
          .select('*, categories(name)')
          .order('created_at', { ascending: false });

        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').classList.remove('hidden');

        if (!products || products.length === 0) {
          document.getElementById('products-container').innerHTML = `
            <div class="text-center py-16 bg-gray-50 rounded-xl border-2 border-dashed border-gray-300">
              <div class="flex justify-center mb-4">
                <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center">
                  <svg class="w-8 h-8 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                  </svg>
                </div>
              </div>
              <p class="text-gray-600 text-lg mb-4">No hay productos aún</p>
              <a href="/admin/productos/nuevo" class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
                Crear Primer Producto
              </a>
            </div>
          `;
          return;
        }

        let html = `
          <div class="overflow-hidden rounded-xl shadow-lg border border-gray-200">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gradient-to-r from-gray-900 to-gray-800 text-white">
                  <tr>
                    <th class="px-6 py-4 text-left text-sm font-semibold">Producto</th>
                    <th class="px-6 py-4 text-left text-sm font-semibold">Categoría</th>
                    <th class="px-6 py-4 text-left text-sm font-semibold">Precio</th>
                    <th class="px-6 py-4 text-center text-sm font-semibold">Stock</th>
                    <th class="px-6 py-4 text-center text-sm font-semibold">Estado</th>
                    <th class="px-6 py-4 text-right text-sm font-semibold">Acciones</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
        `;

        products.forEach((product) => {
          const price = (product.price_cents / 100).toFixed(2).replace('.', ',');
          const stockClass = product.stock === 0 
            ? 'bg-red-100 text-red-800'
            : product.stock <= 5 
              ? 'bg-yellow-100 text-yellow-800'
              : 'bg-green-100 text-green-800';
          const statusBgClass = product.is_active ? 'bg-blue-50' : 'bg-gray-50';

          html += `
            <tr class="${statusBgClass} hover:bg-opacity-75 transition">
              <td class="px-6 py-4">
                <div class="flex items-center gap-3">
                  <div class="w-10 h-10 rounded-lg bg-gray-200 overflow-hidden flex-shrink-0">
                    ${product.images && product.images[0]
                      ? `<img src="${product.images[0]}" alt="${product.name}" class="w-full h-full object-cover" />`
                      : '<div class="w-full h-full flex items-center justify-center text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg></div>'
                    }
                  </div>
                  <div>
                    <p class="font-semibold text-gray-900">${product.name}</p>
                    <p class="text-xs text-gray-500 mt-0.5">${product.slug}</p>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 text-sm text-gray-700">${product.categories?.name || 'Sin categoría'}</td>
              <td class="px-6 py-4 text-sm font-semibold text-gray-900">${price}€</td>
              <td class="px-6 py-4 text-center">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${stockClass}">
                  ${product.stock} unid.
                </span>
              </td>
              <td class="px-6 py-4 text-center">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${
                  product.is_active
                    ? 'bg-indigo-100 text-indigo-800'
                    : 'bg-gray-100 text-gray-800'
                }">
                  ${product.is_active ? 'Activo' : 'Inactivo'}
                </span>
              </td>
              <td class="px-6 py-4 text-right">
                <div class="flex justify-end gap-3">
                  <a href="/admin/productos/${product.id}" class="text-indigo-600 hover:text-indigo-900 font-medium text-sm transition">
                    Editar
                  </a>
                  <button class="text-red-600 hover:text-red-900 font-medium text-sm transition">
                    Eliminar
                  </button>
                </div>
              </td>
            </tr>
          `;
        });

        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;

        document.getElementById('products-container').innerHTML = html;
      } catch (error) {
        console.error('Error loading products:', error);
        document.getElementById('loading').innerHTML = '<p class="text-red-600">Error al cargar los productos</p>';
      }
    })();
  </script>
</AdminLayout>
