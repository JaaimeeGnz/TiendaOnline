---
/**
 * src/pages/admin/productos/nuevo.astro
 * Formulario para crear nuevo producto (SSR)
 */

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseClient } from '../../../lib/supabase';

// Obtener categorías para el select
const { data: categories } = await supabaseClient.from('categories').select('*');
---

<AdminLayout title="Nuevo Producto">
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-primary-800">Crear Nuevo Producto</h1>
    <p class="text-neutral-gray_dark mt-1">Completa el formulario para agregar un nuevo artículo al catálogo</p>
  </div>

  <div class="max-w-2xl">
    <form method="POST" action="/api/admin/products" class="bg-white border border-primary-200 rounded-lg p-8 space-y-8">
      <!-- Nombre -->
      <div>
        <label for="name" class="block text-sm font-semibold text-primary-800 mb-2">
          Nombre del Producto
        </label>
        <input
          type="text"
          id="name"
          name="name"
          required
          placeholder="Ej: Camisa Oxford Premium"
          class="w-full px-4 py-2 border border-primary-300 rounded-sm text-sm focus:outline-none focus:border-primary-800 focus:ring-2 focus:ring-primary-100"
        />
      </div>

      <!-- Descripción -->
      <div>
        <label for="description" class="block text-sm font-semibold text-primary-800 mb-2">
          Descripción
        </label>
        <textarea
          id="description"
          name="description"
          required
          rows="5"
          placeholder="Describe el producto, materiales, características..."
          class="w-full px-4 py-2 border border-primary-300 rounded-sm text-sm focus:outline-none focus:border-primary-800 focus:ring-2 focus:ring-primary-100"
        ></textarea>
      </div>

      <!-- Grid de campos -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Precio -->
        <div>
          <label for="price_cents" class="block text-sm font-semibold text-primary-800 mb-2">
            Precio (en céntimos, ej: 5999 = 59,99€)
          </label>
          <input
            type="number"
            id="price_cents"
            name="price_cents"
            required
            min="0"
            placeholder="5999"
            class="w-full px-4 py-2 border border-primary-300 rounded-sm text-sm focus:outline-none focus:border-primary-800 focus:ring-2 focus:ring-primary-100"
          />
        </div>

        <!-- Stock -->
        <div>
          <label for="stock" class="block text-sm font-semibold text-primary-800 mb-2">
            Stock Disponible
          </label>
          <input
            type="number"
            id="stock"
            name="stock"
            required
            min="0"
            placeholder="50"
            class="w-full px-4 py-2 border border-primary-300 rounded-sm text-sm focus:outline-none focus:border-primary-800 focus:ring-2 focus:ring-primary-100"
          />
        </div>
      </div>

      <!-- Categoría -->
      <div>
        <label for="category_id" class="block text-sm font-semibold text-primary-800 mb-2">
          Categoría
        </label>
        <select
          id="category_id"
          name="category_id"
          required
          class="w-full px-4 py-2 border border-primary-300 rounded-sm text-sm focus:outline-none focus:border-primary-800 focus:ring-2 focus:ring-primary-100"
        >
          <option value="">-- Selecciona una categoría --</option>
          {categories?.map((cat) => (
            <option value={cat.id}>{cat.name}</option>
          ))}
        </select>
      </div>

      <!-- Características adicionales -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="color" class="block text-sm font-semibold text-primary-800 mb-2">
            Color
          </label>
          <input
            type="text"
            id="color"
            name="color"
            placeholder="Blanco"
            class="w-full px-4 py-2 border border-primary-300 rounded-sm text-sm focus:outline-none focus:border-primary-800 focus:ring-2 focus:ring-primary-100"
          />
        </div>

        <div>
          <label for="material" class="block text-sm font-semibold text-primary-800 mb-2">
            Material
          </label>
          <input
            type="text"
            id="material"
            name="material"
            placeholder="Algodón 100%"
            class="w-full px-4 py-2 border border-primary-300 rounded-sm text-sm focus:outline-none focus:border-primary-800 focus:ring-2 focus:ring-primary-100"
          />
        </div>
      </div>

      <!-- SKU -->
      <div>
        <label for="sku" class="block text-sm font-semibold text-primary-800 mb-2">
          SKU (código único)
        </label>
        <input
          type="text"
          id="sku"
          name="sku"
          placeholder="SHIRT-001"
          class="w-full px-4 py-2 border border-primary-300 rounded-sm text-sm focus:outline-none focus:border-primary-800 focus:ring-2 focus:ring-primary-100"
        />
      </div>

      <!-- Imagen -->
      <div>
        <label for="images" class="block text-sm font-semibold text-primary-800 mb-2">
          Imágenes del Producto (arrastra aquí)
        </label>
        <div
          id="dropzone"
          class="w-full border-2 border-dashed border-primary-300 rounded-sm p-8 text-center cursor-pointer hover:border-primary-800 hover:bg-primary-50 transition"
        >
          <input
            type="file"
            id="images"
            name="images"
            multiple
            accept="image/*"
            class="hidden"
          />
          <p class="text-neutral-gray_dark">Arrastra imágenes aquí o haz clic para seleccionar</p>
          <p class="text-xs text-neutral-gray_light mt-2">Formatos: JPG, PNG, WebP (máx 5MB cada una)</p>
        </div>
      </div>

      <!-- Destacado -->
      <div class="flex items-center gap-3">
        <input
          type="checkbox"
          id="featured"
          name="featured"
          class="w-4 h-4 text-primary-800 border-primary-300 rounded focus:ring-2 focus:ring-primary-600"
        />
        <label for="featured" class="text-sm font-medium text-primary-800">
          Marcar como producto destacado
        </label>
      </div>

      <!-- Botones -->
      <div class="flex gap-4 pt-8">
        <button
          type="submit"
          class="flex-1 py-2 bg-green-600 text-neutral-white font-semibold rounded-sm hover:bg-green-700 transition"
        >
          Crear Producto
        </button>
        <a
          href="/admin/productos"
          class="flex-1 py-2 bg-neutral-gray_light text-neutral-gray_dark font-semibold rounded-sm hover:bg-neutral-gray_medium transition text-center"
        >
          Cancelar
        </a>
      </div>
    </form>
  </div>

  <script>
    // Drag and drop para imágenes
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('images');

    if (dropzone && fileInput) {
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach((eventName) => {
        dropzone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e: Event): void {
        e.preventDefault();
        if (e instanceof DragEvent) e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach((eventName) => {
        dropzone?.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach((eventName) => {
        dropzone?.addEventListener(eventName, unhighlight, false);
      });

      function highlight(e: Event): void {
        if (dropzone) {
          dropzone.classList.add('bg-primary-50', 'border-primary-800');
        }
      }

      function unhighlight(e: Event): void {
        if (dropzone) {
          dropzone.classList.remove('bg-primary-50', 'border-primary-800');
        }
      }

      dropzone?.addEventListener('drop', handleDrop, false);
      dropzone?.addEventListener('click', () => (fileInput as HTMLInputElement).click());

      function handleDrop(e: DragEvent): void {
        const dt = e.dataTransfer;
        if (dt?.files) {
          (fileInput as HTMLInputElement).files = dt.files;
        }
      }
    }
  </script>
</AdminLayout>
