---
/**
 * src/pages/admin/productos/nuevo.astro
 * Formulario para crear nuevo producto
 */

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseClient } from '../../../lib/supabase';

// Obtener categorías para el select
const { data: categories } = await supabaseClient.from('categories').select('*');
---

<AdminLayout title="Nuevo Producto">
  <div class="max-w-4xl">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-4xl font-bold text-gray-900">Crear Nuevo Producto</h1>
      <p class="text-gray-600 mt-2">Completa el formulario para agregar un nuevo artículo al catálogo</p>
    </div>

    <form id="product-form" class="bg-white rounded-xl shadow-lg border border-gray-200 p-8 space-y-8">
      <!-- Nombre -->
      <div>
        <label for="name" class="block text-sm font-semibold text-gray-900 mb-3">
          Nombre del Producto *
        </label>
        <input
          type="text"
          id="name"
          name="name"
          required
          placeholder="Ejemplo: Zapatillas Nike Air Max"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
        />
      </div>

      <!-- Descripción -->
      <div>
        <label for="description" class="block text-sm font-semibold text-gray-900 mb-3">
          Descripción *
        </label>
        <textarea
          id="description"
          name="description"
          required
          rows="6"
          placeholder="Describe el producto, materiales, características principales..."
          class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition resize-none"
        ></textarea>
      </div>

      <!-- Grid de campos -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Precio -->
        <div>
          <label for="price_cents" class="block text-sm font-semibold text-gray-900 mb-3">
            Precio (€) *
          </label>
          <input
            type="number"
            id="price_cents"
            name="price_cents"
            required
            min="0"
            step="0.01"
            placeholder="59.99"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
          />
          <p class="text-xs text-gray-500 mt-1">Se almacena en céntimos internamente</p>
        </div>

        <!-- Stock -->
        <div>
          <label for="stock" class="block text-sm font-semibold text-gray-900 mb-3">
            Stock Disponible *
          </label>
          <input
            type="number"
            id="stock"
            name="stock"
            required
            min="0"
            placeholder="50"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
          />
        </div>
      </div>

      <!-- Categoría y otros campos -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Categoría -->
        <div>
          <label for="category_id" class="block text-sm font-semibold text-gray-900 mb-3">
            Categoría *
          </label>
          <select
            id="category_id"
            name="category_id"
            required
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
          >
            <option value="">-- Selecciona una categoría --</option>
            {categories?.map((cat) => (
              <option value={cat.id}>{cat.name}</option>
            ))}
          </select>
        </div>

        <!-- Color -->
        <div>
          <label for="color" class="block text-sm font-semibold text-gray-900 mb-3">
            Color
          </label>
          <input
            type="text"
            id="color"
            name="color"
            placeholder="Negro, Azul, Rojo..."
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
          />
        </div>
      </div>

      <!-- Material y SKU -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <!-- Material -->
        <div>
          <label for="material" class="block text-sm font-semibold text-gray-900 mb-3">
            Material
          </label>
          <input
            type="text"
            id="material"
            name="material"
            placeholder="Algodón, Poliéster, Cuero..."
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
          />
        </div>

        <!-- SKU -->
        <div>
          <label for="sku" class="block text-sm font-semibold text-gray-900 mb-3">
            SKU
          </label>
          <input
            type="text"
            id="sku"
            name="sku"
            placeholder="SKU-001"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition"
          />
        </div>
      </div>

      <!-- Imágenes -->
      <div>
        <label class="block text-sm font-semibold text-gray-900 mb-3">
          Imágenes del Producto
        </label>
        <div id="images-container" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-indigo-500 transition">
          <svg class="mx-auto h-12 w-12 text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <p class="text-gray-600 text-sm">Haz clic para subir imágenes desde Cloudinary</p>
          <p class="text-gray-500 text-xs mt-1">PNG, JPG hasta 5MB</p>
          <input type="hidden" id="images_json" name="images_json" />
        </div>
      </div>

      <!-- Botones -->
      <div class="flex gap-4 pt-8 border-t border-gray-200">
        <button
          type="submit"
          class="flex-1 py-3 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition flex items-center justify-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          Crear Producto
        </button>
        <a
          href="/admin/productos"
          class="flex-1 py-3 bg-gray-200 text-gray-900 font-semibold rounded-lg hover:bg-gray-300 transition text-center flex items-center justify-center gap-2"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          Cancelar
        </a>
      </div>
    </form>
  </div>

  <script is:inline src="https://upload-widget.cloudinary.com/latest/global/all.js"></script>

  <script>
    document.getElementById('product-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(document.getElementById('product-form'));
      
      // Convertir precio a céntimos si es necesario
      const price = formData.get('price_cents');
      if (price && price.includes('.')) {
        formData.set('price_cents', Math.round(parseFloat(price) * 100));
      }
      
      try {
        const response = await fetch('/api/admin/products', {
          method: 'POST',
          body: formData,
        });
        
        if (response.ok) {
          alert('Producto creado exitosamente');
          window.location.href = '/admin/productos';
        } else {
          const error = await response.json();
          alert('Error: ' + (error.error || 'Error desconocido'));
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al crear el producto');
      }
    });
  </script>
</AdminLayout>
