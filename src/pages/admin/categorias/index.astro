---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabaseClient } from '../../../lib/supabase';

// Obtener categorías con sus productos
const { data: categories } = await supabaseClient
  .from('categories')
  .select('*')
  .order('name', { ascending: true });

const { data: products } = await supabaseClient
  .from('products')
  .select('id, name, category_id');

// Agrupar productos por categoría
const productsByCategory: Record<string, any[]> = {};
if (categories) {
  categories.forEach(cat => {
    productsByCategory[cat.id] = products?.filter(p => p.category_id === cat.id) || [];
  });
}
---

<AdminLayout title="Gestionar Categorías">
  <div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-4xl font-black text-jd-black">Gestionar Categorías</h1>
        <p class="text-gray-600 mt-2">Visualiza y organiza los productos por categoría</p>
      </div>
      <a href="/admin" class="flex items-center gap-2 px-6 py-3 bg-gray-600 text-white font-bold rounded-lg hover:bg-gray-700 transition">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Volver
      </a>
    </div>

    <!-- Categories Grid -->
    <div class="grid grid-cols-1 gap-6">
      {categories && categories.map(category => (
        <div class="bg-white border-2 border-gray-200 rounded-lg p-6 hover:shadow-lg transition">
          <!-- Category Header -->
          <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-gray-200">
            <div>
              <h2 class="text-2xl font-black text-jd-black">{category.name}</h2>
              {category.description && (
                <p class="text-gray-600 mt-1 text-sm">{category.description}</p>
              )}
            </div>
            <div class="bg-jd-turquoise bg-opacity-10 px-4 py-2 rounded-lg">
              <p class="text-sm font-bold text-jd-turquoise">
                {productsByCategory[category.id]?.length || 0} productos
              </p>
            </div>
          </div>

          <!-- Products List -->
          {productsByCategory[category.id]?.length > 0 ? (
            <div class="space-y-3">
              {productsByCategory[category.id]?.map(product => (
                <div key={product.id} class="flex items-center justify-between p-4 bg-gray-50 rounded-lg hover:bg-gray-100 transition">
                  <div class="flex-1">
                    <p class="font-semibold text-gray-900">{product.name}</p>
                    <p class="text-xs text-gray-500 mt-1">{product.id}</p>
                  </div>
                  <select 
                    class="px-4 py-2 bg-white border-2 border-gray-300 rounded-lg font-semibold text-gray-900 hover:border-jd-turquoise transition cursor-pointer"
                    onchange={`changeProductCategory('${product.id}', this.value, '${category.id}')`}
                    value={category.id}
                  >
                    <option value={category.id}>{category.name}</option>
                    {categories?.filter(c => c.id !== category.id).map(c => (
                      <option value={c.id}>{c.name}</option>
                    ))}
                  </select>
                </div>
              ))}
            </div>
          ) : (
            <div class="py-8 text-center">
              <p class="text-gray-500 font-semibold">No hay productos en esta categoría</p>
            </div>
          )}
        </div>
      ))}
    </div>
  </div>

  <script>
    async function changeProductCategory(productId: string, newCategoryId: string, oldCategoryId: string) {
      if (newCategoryId === oldCategoryId) return;
      
      try {
        const response = await fetch('/api/admin/products/update-category', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            productId,
            categoryId: newCategoryId,
          }),
        });

        if (response.ok) {
          // Recargar la página para ver los cambios
          window.location.reload();
        } else {
          alert('Error al cambiar la categoría');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error al cambiar la categoría');
      }
    }
    
    // Hacer función global
    (window as any).changeProductCategory = changeProductCategory;
  </script>
</AdminLayout>
