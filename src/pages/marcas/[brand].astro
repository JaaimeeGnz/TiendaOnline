---
/**
 * src/pages/marcas/[brand].astro
 * Página de productos por marca
 */

import PublicLayout from "../../layouts/PublicLayout.astro";
import ProductCard from "../../components/product/ProductCard.astro";
import { supabaseClient } from "../../lib/supabase";

// Obtener todas las marcas para generar rutas estáticas
export async function getStaticPaths() {
  const { data: products } = await supabaseClient
    .from("products")
    .select("brand")
    .eq("is_active", true)
    .not("brand", "is", null);

  const brands = [...new Set(products?.map((p) => p.brand).filter(Boolean) || [])];

  return brands.map((brand) => ({
    params: { brand: brand.toLowerCase().replace(/\s+/g, "-") } as const,
    props: { brandName: brand },
  }));
}

interface Props {
  brandName: string;
}

const { brandName } = Astro.props;
const { brand } = Astro.params;

// Obtener productos de la marca
const { data: products } = await supabaseClient
  .from("products")
  .select("*")
  .eq("brand", brandName)
  .eq("is_active", true)
  .order("featured", { ascending: false })
  .order("created_at", { ascending: false });

if (!products || products.length === 0) {
  return Astro.redirect("/marcas");
}
---

<PublicLayout title={`${brandName} - FashionMarket`} description={`Todos los productos de ${brandName}`}>
  <div class="bg-jd-gray min-h-screen">
    <div class="max-w-7xl mx-auto px-4 py-8">
      <!-- Breadcrumb -->
      <nav class="flex items-center gap-2 mb-6 text-sm text-gray-500">
        <a href="/" class="hover:text-jd-black transition">Inicio</a>
        <span>/</span>
        <a href="/marcas" class="hover:text-jd-black transition">Marcas</a>
        <span>/</span>
        <span class="text-jd-black font-bold">{brandName}</span>
      </nav>

      <!-- Header -->
      <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
          <h1 class="text-4xl font-black text-jd-black uppercase">{brandName}</h1>
          <p class="text-gray-500 mt-1">{products.length} productos</p>
        </div>
      </div>

      <!-- Productos Grid -->
      {
        products.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            {products.map((product) => (
              <ProductCard product={product} />
            ))}
          </div>
        ) : (
          <div class="text-center py-12">
            <p class="text-gray-500 text-lg">
              No hay productos de {brandName} en este momento
            </p>
          </div>
        )
      }
    </div>
  </div>
</PublicLayout>
